#!/bin/bash
# openssl genpkey -algorithm X25519 -out client-ephemeral-private.key

# clienthello=010000f40303000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f20e0e1e2e3e4e5e6e7e8e9eaebecedeeeff0f1f2f3f4f5f6f7f8f9fafbfcfdfeff000813021303130100ff010000a30000001800160000136578616d706c652e756c666865696d2e6e6574000b000403000102000a00160014001d0017001e0019001801000101010201030104002300000016000000170000000d001e001c040305030603080708080809080a080b080408050806040105010601002b0003020304002d00020101003300260024001d0020358072d6365880d1aeea329adf9121383851ed21a28e3b75e965d0d2cd166254
# serverhello=020000760303707172737475767778797a7b7c7d7e7f808182838485868788898a8b8c8d8e8f20e0e1e2e3e4e5e6e7e8e9eaebecedeeeff0f1f2f3f4f5f6f7f8f9fafbfcfdfeff130200002e002b0002030400330024001d00209fd7ad6dcff4298dd3f96d5b1b2af910a0535b1488d7f8fabb349a982880b615
# clientprivatekey=202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f
# serverpublickey=9fd7ad6dcff4298dd3f96d5b1b2af910a0535b1488d7f8fabb349a982880b615
# concat=010000f40303000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f20e0e1e2e3e4e5e6e7e8e9eaebecedeeeff0f1f2f3f4f5f6f7f8f9fafbfcfdfeff000813021303130100ff010000a30000001800160000136578616d706c652e756c666865696d2e6e6574000b000403000102000a00160014001d0017001e0019001801000101010201030104002300000016000000170000000d001e001c040305030603080708080809080a080b080408050806040105010601002b0003020304002d00020101003300260024001d0020358072d6365880d1aeea329adf9121383851ed21a28e3b75e965d0d2cd166254020000760303707172737475767778797a7b7c7d7e7f808182838485868788898a8b8c8d8e8f20e0e1e2e3e4e5e6e7e8e9eaebecedeeeff0f1f2f3f4f5f6f7f8f9fafbfcfdfeff130200002e002b0002030400330024001d00209fd7ad6dcff4298dd3f96d5b1b2af910a0535b1488d7f8fabb349a982880b6150800000200000b00032e0000032a0003253082032130820209a0030201020208155a92adc2048f90300d06092a864886f70d01010b05003022310b300906035504061302555331133011060355040a130a4578616d706c65204341301e170d3138313030353031333831375a170d3139313030353031333831375a302b310b3009060355040613025553311c301a060355040313136578616d706c652e756c666865696d2e6e657430820122300d06092a864886f70d01010105000382010f003082010a0282010100c4803606bae7476b089404eca7b691043ff792bc19eefb7d74d7a80d001e7b4b3a4ae60fe8c071fc73e7024c0dbcf4bdd11d396bba70464a13e94af83df3e10959547bc955fb412da3765211e1f3dc776caa53376eca3aecbec3aab73b31d56cb6529c8098bcc9e02818e20bf7f8a03afd1704509ece79bd9f39f1ea69ec47972e830fb5ca95de95a1e60422d5eebe527954a1e7bf8a86f6466d0d9f16951a4cf7a04692595c1352f2549e5afb4ebfd77a37950144e4c026874c653e407d7d23074401f484ffd08f7a1fa05210d1f4f0d5ce79702932e2cabe701fdfad6b4bb71101f44bad666a11130fe2ee829e4d029dc91cdd6716dbb9061886edc1ba94210203010001a3523050300e0603551d0f0101ff0404030205a0301d0603551d250416301406082b0601050507030206082b06010505070301301f0603551d23041830168014894fde5bcc69e252cf3ea300dfb197b81de1c146300d06092a864886f70d01010b05000382010100591645a69a2e3779e4f6dd271aba1c0bfd6cd75599b5e7c36e533eff3659084324c9e7a504079d39e0d42987ffe3ebdd09c1cf1d914455870b571dd19bdf1d24f8bb9a11fe80fd592ba0398cde11e2651e618ce598fa96e5372eef3d248afde17463ebbfabb8e4d1ab502a54ec0064e92f7819660d3f27cf209e667fce5ae2e4ac99c7c93818f8b2510722dfed97f32e3e9349d4c66c9ea6396d744462a06b42c6d5ba688eac3a017bddfc8e2cfcad27cb69d3ccdca280414465d3ae348ce0f34ab2fb9c618371312b191041641c237f11a5d65c844f0404849938712b959ed685bc5c5dd645ed19909473402926dcb40e3469a15941e8e2cca84bb6084636a000000f000104080401005cbb24c0409332daa920bbabbdb9bd50170be49cfbe0a4107fca6ffb1068e65f969e6de7d4f9e56038d67c69c031403a7a7c0bcc8683e65721a0c72cc6634019ad1d3ad265a812615ba36380372084f5daec7e63d3f4933f27227419a611034644dcdbc7be3e74ffac473faaadde8c2fc65f3265773e7e62de33861fa705d19c506e896c8d82f5bcf35fece259b71538115e9c8cfba62e49bb8474f58587b11b8ae317c633e9c76c791d466284ad9c4ff735a6d2e963b59bbca440a307091a1b4e46bcc7a2f9fb2f1c898ecb19918be4121d7e8ed04cd50c9a59e987980107bbbf299c232e7fdbe10a4cfdae5c891c96afdff94b54ccd2bc19d3cdaa6644859c140000307e30eeccb6b23be6c6ca363992e842da877ee64715ae7fc0cf87f9e5032182b5bb48d1e33f9979055a160c8dbbb1569c
# recordnum=0
# recdata=1703030015
# mydata=70696e6717

clienthello=$1
serverhello=$2
clientprivatekey=$3
serverpublickey=$4
recordnum=$5
recdata=$6
mydata=$7
concat=$8

echo $mydata | xxd -r -p > /tmp/msg1

dir="/home/mashroor/Documents/4-2/thesis_final/tls1_3_statelearner/tmp"

# cc -o $dir/curve25519-mult $dir/curve25519-mult.c
shared_secret=$($dir/curve25519-mult $clientprivatekey $serverpublickey)
hello_hash=$((echo -n "$clienthello" | xxd -r -p; echo -n "$serverhello" | xxd -r -p) | openssl dgst -sha384 | cut -d ' ' -f 2)
zero_key=000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
early_secret=$($dir/hkdf-384.sh extract 00 $zero_key)
empty_hash=$(openssl sha384 < /dev/null | sed -e 's/.* //')
derived_secret=$($dir/hkdf-384.sh expandlabel $early_secret "derived" $empty_hash 48)
handshake_secret=$($dir/hkdf-384.sh extract $derived_secret $shared_secret)
csecret=$($dir/hkdf-384.sh expandlabel $handshake_secret "c hs traffic" $hello_hash 48)
ssecret=$($dir/hkdf-384.sh expandlabel $handshake_secret "s hs traffic" $hello_hash 48)


handshake_hash=$($dir/temp2.sh $concat)
derived_secret_2=$($dir/hkdf-384.sh expandlabel $handshake_secret "derived" $empty_hash 48)
master_secret=$($dir/hkdf-384.sh extract $derived_secret_2 $zero_key)
csecret2=$($dir/hkdf-384.sh expandlabel $master_secret "c ap traffic" $handshake_hash 48)
ssecret2=$($dir/hkdf-384.sh expandlabel $master_secret "s ap traffic" $handshake_hash 48)
client_application_key=$($dir/hkdf-384.sh expandlabel $csecret2 "key" "" 32)
server_application_key=$($dir/hkdf-384.sh expandlabel $ssecret2 "key" "" 32)
client_application_iv=$($dir/hkdf-384.sh expandlabel $csecret2 "iv" "" 12)
server_application_iv=$($dir/hkdf-384.sh expandlabel $ssecret2 "iv" "" 12)


if [ "$9" = "client" ]; then
    key=$client_application_key
    iv=$client_application_iv
else
    key=$server_application_key
    iv=$server_application_iv
fi

cc -o $dir/aes_256_gcm_encrypt $dir/aes_256_gcm_encrypt.c -lssl -lcrypto
cat /tmp/msg1 \
  | $dir/aes_256_gcm_encrypt $iv $recordnum $key $recdata \
  | xxd -p -c 128